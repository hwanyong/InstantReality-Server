<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Calibration - Gemini Robotics</title>
    <meta name="description" content="AI-powered automatic robot calibration using Gemini vision">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for calibration page */
        .calibration-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap);
        }

        @media (max-width: 1200px) {
            .calibration-grid {
                grid-template-columns: 1fr;
            }
        }

        .progress-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            height: 8px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        .calibration-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .calibration-step {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calibration-step.active {
            border-left: 3px solid var(--accent);
        }

        .calibration-step.done {
            opacity: 0.7;
        }

        .calibration-step.done::before {
            content: 'âœ“';
            color: var(--success);
            font-weight: bold;
        }

        .step-icon {
            font-size: 1.5rem;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 500;
        }

        .step-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .tool-btn {
            transition: all 0.2s ease;
        }

        .tool-btn.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .tool-btn[data-tool="left-base"],
        .tool-btn[data-tool="left-gripper"] {
            border-color: #ff6b6b;
        }

        .tool-btn[data-tool="left-base"].active,
        .tool-btn[data-tool="left-gripper"].active {
            background: #ff6b6b;
        }

        .tool-btn[data-tool="right-base"],
        .tool-btn[data-tool="right-gripper"] {
            border-color: #4dabf7;
        }

        .tool-btn[data-tool="right-base"].active,
        .tool-btn[data-tool="right-gripper"].active {
            background: #4dabf7;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .json-preview {
            font-family: 'Consolas', monospace;
            font-size: 0.7rem;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .nav-links {
            display: flex;
            gap: 12px;
        }

        .nav-links a {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.875rem;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .workspace-viz {
            position: relative;
            width: 100%;
            aspect-ratio: 1.2;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        .workspace-viz canvas {
            width: 100%;
            height: 100%;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-group .btn {
            flex: 1;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>ğŸ¯ Robot Calibration</h1>
            <div class="status-bar">
                <nav class="nav-links">
                    <a href="index.html">â† Back to Control</a>
                    <a href="settings.html">Settings</a>
                </nav>
                <span id="connection-status" class="status disconnected">â— Disconnected</span>
            </div>
        </header>

        <main class="main-content calibration-grid">
            <!-- Left Panel: Camera + Visualization -->
            <section>
                <!-- Camera View -->
                <div class="video-section">
                    <h2>ğŸ“¹ Camera View <span style="font-size: 12px; color: var(--text-secondary);">(Calibration uses
                            TopView + QuarterView)</span></h2>

                    <!-- TopView with Overlay -->
                    <div id="topview-container" style="position: relative; margin-bottom: 12px;">
                        <video id="camera-0" autoplay playsinline muted
                            style="width: 800px; height: 450px; border: 2px solid var(--accent); border-radius: 8px; background: #000; object-fit: cover;"></video>
                        <canvas id="overlay-canvas" width="800" height="450"
                            style="position: absolute; top: 0; left: 0; pointer-events: auto; border-radius: 8px;"></canvas>
                        <div id="topview-label"
                            style="position: absolute; top: 8px; left: 12px; font-size: 12px; color: var(--accent); background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px;">
                            ğŸ¯ TopView</div>
                    </div>

                    <!-- Overlay Toolbar -->
                    <div id="overlay-toolbar" style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <button id="tool-vertex" class="btn tool-btn active" data-tool="vertex">â¬¡ Add Vertex</button>
                        <button id="tool-left-base" class="btn tool-btn" data-tool="left-base">â—† Left Base</button>
                        <button id="tool-right-base" class="btn tool-btn" data-tool="right-base">â—† Right Base</button>
                        <button id="tool-left-gripper" class="btn tool-btn" data-tool="left-gripper">â˜… Left
                            Gripper</button>
                        <button id="tool-right-gripper" class="btn tool-btn" data-tool="right-gripper">â˜… Right
                            Gripper</button>
                        <button id="tool-clear" class="btn btn-danger">ğŸ—‘ Clear All</button>
                    </div>

                    <!-- Secondary Cameras (horizontal) -->
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <div class="video-wrapper" style="flex: 1;">
                            <label style="font-size: 11px; color: var(--accent);">ğŸ¯ QuarterView</label>
                            <video id="camera-1" autoplay playsinline muted
                                style="width: 100%; height: 150px; border: 2px solid var(--accent); border-radius: 4px; background: #000; object-fit: cover;"></video>
                        </div>
                        <div class="video-wrapper" style="flex: 1;">
                            <label style="font-size: 11px; color: var(--text-secondary);">RightRobot</label>
                            <video id="camera-2" autoplay playsinline muted
                                style="width: 100%; height: 150px; border: 1px solid var(--border); border-radius: 4px; background: #000; object-fit: cover;"></video>
                        </div>
                        <div class="video-wrapper" style="flex: 1;">
                            <label style="font-size: 11px; color: var(--text-secondary);">LeftRobot</label>
                            <video id="camera-3" autoplay playsinline muted
                                style="width: 100%; height: 150px; border: 1px solid var(--border); border-radius: 4px; background: #000; object-fit: cover;"></video>
                        </div>
                    </div>

                    <div class="video-controls">
                        <button id="capture-btn" class="btn">ğŸ“· Capture</button>
                        <button id="detect-base-btn" class="btn">ğŸ” Detect Robot Base</button>
                        <button id="detect-gripper-btn" class="btn">âœ‹ Detect Gripper</button>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Calibration Controls -->
            <section class="control-section">
                <!-- Robot Connection Test -->
                <div class="control-card">
                    <h3>ğŸ¤– Robot Control</h3>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px;">
                        ë¡œë´‡ ì—°ê²° ë° í¬ì§€ì…˜ ì œì–´ í…ŒìŠ¤íŠ¸
                    </p>

                    <div class="calibration-status" id="robot-status">Disconnected</div>

                    <div class="btn-group">
                        <button id="robot-connect-btn" class="btn-primary">ğŸ”Œ Connect</button>
                        <button id="robot-disconnect-btn" class="btn-danger" disabled>â›” Disconnect</button>
                    </div>
                    <div class="btn-group" style="margin-top: 8px;">
                        <button id="go-home-btn" class="btn" disabled>ğŸ  Go Home</button>
                        <button id="go-zero-btn" class="btn" disabled>ğŸ“ Go to Zero</button>
                    </div>
                    <div class="control-row" style="margin-top: 12px;">
                        <label style="font-size: 0.75rem; color: var(--text-secondary);">ëª¨ì…˜ ì†ë„</label>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                            <input type="range" id="motion-speed" min="0.5" max="5" step="0.5" value="3"
                                style="flex: 1; accent-color: var(--accent);">
                            <span id="speed-value" style="font-size: 0.85rem; min-width: 35px;">3ì´ˆ</span>
                        </div>
                    </div>
                </div>

                <!-- Auto-Calibration -->
                <div class="control-card">
                    <h3>ğŸ¯ Auto-Calibration</h3>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px;">
                        AIê°€ ë¡œë´‡ ìœ„ì¹˜ë¥¼ ìë™ ê°ì§€í•˜ê³  ì¹´ë©”ë¼-ë¡œë´‡ ì¢Œí‘œ ë³€í™˜ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
                    </p>

                    <div class="calibration-status" id="cal-status">Ready to calibrate</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="cal-progress"></div>
                    </div>

                    <!-- Calibration Steps -->
                    <div id="cal-steps">
                        <div class="calibration-step" id="step-1">
                            <span class="step-icon">ğŸ </span>
                            <div class="step-content">
                                <div class="step-title">Phase 0: ì´ˆê¸°í™”</div>
                                <div class="step-desc">Home ì´ë™ ë° 4ì¹´ë©”ë¼ í™•ì¸</div>
                            </div>
                        </div>
                        <div class="calibration-step" id="step-2">
                            <span class="step-icon">ğŸ“</span>
                            <div class="step-content">
                                <div class="step-title">Phase 1: TopView Homography</div>
                                <div class="step-desc">FK ê¸°ë°˜ 9í¬ì¸íŠ¸ ìê¸° íƒìƒ‰</div>
                            </div>
                        </div>
                        <div class="calibration-step" id="step-3">
                            <span class="step-icon">ğŸ“</span>
                            <div class="step-content">
                                <div class="step-title">Phase 2: Z-Height ìº˜ë¦¬ë¸Œë ˆì´ì…˜</div>
                                <div class="step-desc">QuarterViewë¡œ 4ë‹¨ê³„ ë†’ì´ ë§¤í•‘</div>
                            </div>
                        </div>
                        <div class="calibration-step" id="step-4">
                            <span class="step-icon">âœ…</span>
                            <div class="step-content">
                                <div class="step-title">Phase 3: êµì°¨ ê²€ì¦</div>
                                <div class="step-desc">RobotCamera ì •ë°€ë„ í™•ì¸</div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button id="start-cal-btn" class="btn-primary">ğŸš€ Start Calibration</button>
                        <button id="stop-cal-btn" class="btn-danger" disabled>â¹ Stop</button>
                    </div>
                </div>

                <!-- Manual Grid Control (Hidden - Zero-Reference uses automatic positioning) -->
                <div class="control-card" style="display: none;">
                    <h3>ğŸ›ï¸ Manual Grid Control</h3>
                    <div class="ik-inputs">
                        <label>Grid Size:
                            <select id="grid-size">
                                <option value="4">2Ã—2 (4ì )</option>
                                <option value="9" selected>3Ã—3 (9ì )</option>
                                <option value="16">4Ã—4 (16ì )</option>
                            </select>
                        </label>
                        <label>Z Height:
                            <input type="number" id="cal-z" value="120" step="10">
                        </label>
                    </div>
                    <button id="test-grid-btn" class="btn">ğŸ“ Preview Grid Points</button>
                </div>

                <!-- Calibration Quality -->
                <div class="control-card">
                    <h3>ğŸ“Š Calibration Quality</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-mean-err">--</div>
                            <div class="stat-label">Mean Error (mm)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-max-err">--</div>
                            <div class="stat-label">Max Error (mm)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-status">â“</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                    <button id="verify-cal-btn" class="btn" style="width: 100%; margin-top: 12px;">ğŸ”¬ Verify
                        Calibration</button>
                </div>

                <!-- Calibration Data -->
                <div class="control-card">
                    <h3>ğŸ’¾ calibration.json</h3>
                    <pre id="json-preview" class="json-preview">No calibration data</pre>
                    <div class="btn-group">
                        <button id="load-cal-btn" class="btn">ğŸ“‚ Load</button>
                        <button id="save-cal-btn" class="btn">ğŸ’¾ Save</button>
                        <button id="export-cal-btn" class="btn">ğŸ“¤ Export</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module" src="calibration.mjs"></script>
</body>

</html>